"use strict";
/**
 * MJOSÂ∑•‰ΩúÊµÅÂºïÊìé - ‰ªøÂÖ¨Âè∏Ê†áÂáÜÊìç‰ΩúÁ®ãÂ∫èÔºàSOPÔºâ
 * Workflow Engine - Mimicking Company Standard Operating Procedures
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.WorkflowEngine = void 0;
class WorkflowEngine {
    constructor() {
        this.templates = new Map();
        this.instances = new Map();
        this.executionQueue = [];
        this.isProcessing = false;
        this.initializeStandardWorkflows();
        this.startProcessingEngine();
    }
    /**
     * ÂàõÂª∫Â∑•‰ΩúÊµÅÊ®°Êùø
     */
    createTemplate(template) {
        const templateId = `wf_template_${Date.now()}`;
        const fullTemplate = {
            ...template,
            id: templateId,
            metadata: {
                createdBy: 'system',
                createdAt: new Date(),
                updatedBy: 'system',
                updatedAt: new Date(),
                usageCount: 0,
                successRate: 0
            }
        };
        this.templates.set(templateId, fullTemplate);
        return templateId;
    }
    /**
     * ÂêØÂä®Â∑•‰ΩúÊµÅÂÆû‰æã
     */
    async startWorkflow(templateId, initiator, context = {}) {
        const template = this.templates.get(templateId);
        if (!template) {
            throw new Error(`Â∑•‰ΩúÊµÅÊ®°Êùø ${templateId} ‰∏çÂ≠òÂú®`);
        }
        const instanceId = `wf_instance_${Date.now()}`;
        const instance = {
            id: instanceId,
            templateId,
            name: `${template.name} - ${new Date().toLocaleString()}`,
            status: 'pending',
            startedBy: initiator,
            startedAt: new Date(),
            currentStep: template.steps[0].id,
            context: new Map(Object.entries(context)),
            variables: new Map(),
            executionHistory: [],
            approvalHistory: [],
            qualityCheckHistory: [],
            metrics: {
                totalDuration: 0,
                stepCount: 0,
                errorCount: 0,
                approvalCount: 0
            }
        };
        this.instances.set(instanceId, instance);
        this.executionQueue.push(instanceId);
        // Êõ¥Êñ∞Ê®°Êùø‰ΩøÁî®ÁªüËÆ°
        template.metadata.usageCount++;
        return instanceId;
    }
    /**
     * ÊâßË°åÂ∑•‰ΩúÊµÅÊ≠•È™§
     */
    async executeStep(instanceId, stepId) {
        const instance = this.instances.get(instanceId);
        if (!instance) {
            throw new Error(`Â∑•‰ΩúÊµÅÂÆû‰æã ${instanceId} ‰∏çÂ≠òÂú®`);
        }
        const template = this.templates.get(instance.templateId);
        if (!template) {
            throw new Error(`Â∑•‰ΩúÊµÅÊ®°Êùø ${instance.templateId} ‰∏çÂ≠òÂú®`);
        }
        const step = template.steps.find(s => s.id === stepId);
        if (!step) {
            throw new Error(`Â∑•‰ΩúÊµÅÊ≠•È™§ ${stepId} ‰∏çÂ≠òÂú®`);
        }
        try {
            // Ê£ÄÊü•ÂâçÁΩÆÊù°‰ª∂
            const preconditionsMet = await this.checkPreconditions(step, instance);
            if (!preconditionsMet) {
                throw new Error(`Ê≠•È™§ ${step.name} ÁöÑÂâçÁΩÆÊù°‰ª∂Êú™Êª°Ë∂≥`);
            }
            // ÂºÄÂßãÊâßË°åÊ≠•È™§
            const execution = {
                stepId,
                executor: step.executor,
                startedAt: new Date(),
                status: 'running',
                inputs: this.prepareStepInputs(step, instance),
                duration: 0
            };
            instance.executionHistory.push(execution);
            instance.status = 'running';
            instance.currentStep = stepId;
            // Ê†πÊçÆÊ≠•È™§Á±ªÂûãÊâßË°å‰∏çÂêåÈÄªËæë
            const result = await this.executeStepByType(step, instance, execution);
            // Êõ¥Êñ∞ÊâßË°åËÆ∞ÂΩï
            execution.completedAt = new Date();
            execution.status = result.success ? 'completed' : 'failed';
            execution.outputs = result.outputs;
            execution.error = result.error;
            execution.duration = execution.completedAt.getTime() - execution.startedAt.getTime();
            // Ê£ÄÊü•ÂêéÁΩÆÊù°‰ª∂
            if (result.success) {
                const postconditionsMet = await this.checkPostconditions(step, instance);
                if (!postconditionsMet) {
                    execution.status = 'failed';
                    execution.error = 'ÂêéÁΩÆÊù°‰ª∂Ê£ÄÊü•Â§±Ë¥•';
                    result.success = false;
                }
            }
            // Ë¥®ÈáèÊ£ÄÊü•
            if (result.success) {
                const qualityPassed = await this.performQualityCheck(step, instance);
                if (!qualityPassed) {
                    execution.status = 'failed';
                    execution.error = 'Ë¥®ÈáèÊ£ÄÊü•Êú™ÈÄöËøá';
                    result.success = false;
                }
            }
            // ÂÆ°ÊâπÊµÅÁ®ã
            if (result.success) {
                const approvalPassed = await this.performApproval(step, instance);
                if (!approvalPassed) {
                    instance.status = 'paused';
                    return false; // Á≠âÂæÖÂÆ°Êâπ
                }
            }
            // Êõ¥Êñ∞ÂÆû‰æãÁä∂ÊÄÅ
            instance.metrics.stepCount++;
            if (!result.success) {
                instance.metrics.errorCount++;
            }
            // Á°ÆÂÆö‰∏ã‰∏ÄÊ≠•
            if (result.success && step.nextSteps.length > 0) {
                instance.currentStep = step.nextSteps[0]; // ÁÆÄÂåñÂÆûÁé∞ÔºåÈÄâÊã©Á¨¨‰∏Ä‰∏™‰∏ã‰∏ÄÊ≠•
            }
            else if (result.success) {
                // Â∑•‰ΩúÊµÅÂÆåÊàê
                instance.status = 'completed';
                instance.completedAt = new Date();
                instance.metrics.totalDuration = instance.completedAt.getTime() - instance.startedAt.getTime();
                // Êõ¥Êñ∞Ê®°ÊùøÊàêÂäüÁéá
                this.updateTemplateSuccessRate(template.id, true);
            }
            else {
                // Ê≠•È™§Â§±Ë¥•ÔºåÂ§ÑÁêÜÈîôËØØ
                await this.handleStepError(step, instance, execution);
            }
            return result.success;
        }
        catch (error) {
            console.error(`ÊâßË°åÂ∑•‰ΩúÊµÅÊ≠•È™§Â§±Ë¥•:`, error);
            instance.status = 'failed';
            instance.metrics.errorCount++;
            this.updateTemplateSuccessRate(template.id, false);
            return false;
        }
    }
    /**
     * Ëé∑ÂèñÂ∑•‰ΩúÊµÅÁä∂ÊÄÅ
     */
    getWorkflowStatus(instanceId) {
        return this.instances.get(instanceId) || null;
    }
    /**
     * ÊöÇÂÅúÂ∑•‰ΩúÊµÅ
     */
    pauseWorkflow(instanceId) {
        const instance = this.instances.get(instanceId);
        if (instance && instance.status === 'running') {
            instance.status = 'paused';
            return true;
        }
        return false;
    }
    /**
     * ÊÅ¢Â§çÂ∑•‰ΩúÊµÅ
     */
    resumeWorkflow(instanceId) {
        const instance = this.instances.get(instanceId);
        if (instance && instance.status === 'paused') {
            instance.status = 'running';
            this.executionQueue.push(instanceId);
            return true;
        }
        return false;
    }
    /**
     * ÂèñÊ∂àÂ∑•‰ΩúÊµÅ
     */
    cancelWorkflow(instanceId, reason) {
        const instance = this.instances.get(instanceId);
        if (instance && ['pending', 'running', 'paused'].includes(instance.status)) {
            instance.status = 'cancelled';
            instance.completedAt = new Date();
            // ËÆ∞ÂΩïÂèñÊ∂àÂéüÂõ†
            instance.context.set('cancellationReason', reason);
            return true;
        }
        return false;
    }
    /**
     * ÁîüÊàêÂ∑•‰ΩúÊµÅÊä•Âëä
     */
    generateWorkflowReport() {
        const totalInstances = this.instances.size;
        const completedInstances = Array.from(this.instances.values()).filter(i => i.status === 'completed').length;
        const failedInstances = Array.from(this.instances.values()).filter(i => i.status === 'failed').length;
        const runningInstances = Array.from(this.instances.values()).filter(i => i.status === 'running').length;
        const avgDuration = this.calculateAverageDuration();
        const topTemplates = this.getTopUsedTemplates();
        const performanceMetrics = this.calculatePerformanceMetrics();
        return `
üîÑ MJOSÂ∑•‰ΩúÊµÅÂºïÊìéÊä•Âëä

üìä ÂÆû‰æãÁªüËÆ°:
‚Ä¢ ÊÄªÂÆû‰æãÊï∞: ${totalInstances}
‚Ä¢ Â∑≤ÂÆåÊàê: ${completedInstances}
‚Ä¢ Â§±Ë¥•: ${failedInstances}
‚Ä¢ ËøêË°å‰∏≠: ${runningInstances}
‚Ä¢ ÊàêÂäüÁéá: ${totalInstances > 0 ? (completedInstances / totalInstances * 100).toFixed(1) : 0}%

‚è±Ô∏è ÊÄßËÉΩÊåáÊ†á:
‚Ä¢ Âπ≥ÂùáÊâßË°åÊó∂Èó¥: ${avgDuration}ÂàÜÈíü
‚Ä¢ Âπ≥ÂùáÊ≠•È™§Êï∞: ${performanceMetrics.avgSteps}
‚Ä¢ Âπ≥ÂùáÈîôËØØÁéá: ${performanceMetrics.avgErrorRate.toFixed(2)}%

üèÜ ÁÉ≠Èó®Ê®°Êùø:
${topTemplates.map((template, index) => `${index + 1}. ${template.name} - ${template.usageCount}Ê¨°‰ΩøÁî®`).join('\n')}

üí° ‰ºòÂåñÂª∫ËÆÆ:
${this.generateOptimizationSuggestions().join('\n')}
    `;
    }
    // ÁßÅÊúâÊñπÊ≥ïÂÆûÁé∞
    initializeStandardWorkflows() {
        // ÂàùÂßãÂåñÊ†áÂáÜÂ∑•‰ΩúÊµÅÊ®°Êùø
        this.createStandardTemplates();
    }
    startProcessingEngine() {
        // ÂêØÂä®Â∑•‰ΩúÊµÅÂ§ÑÁêÜÂºïÊìé
        setInterval(() => {
            if (!this.isProcessing && this.executionQueue.length > 0) {
                this.processNextWorkflow();
            }
        }, 1000);
    }
    async processNextWorkflow() {
        if (this.executionQueue.length === 0)
            return;
        this.isProcessing = true;
        const instanceId = this.executionQueue.shift();
        try {
            const instance = this.instances.get(instanceId);
            if (instance && instance.status === 'running') {
                await this.executeStep(instanceId, instance.currentStep);
            }
        }
        catch (error) {
            console.error('Â§ÑÁêÜÂ∑•‰ΩúÊµÅÂ§±Ë¥•:', error);
        }
        finally {
            this.isProcessing = false;
        }
    }
    // ÂÖ∂‰ªñÁßÅÊúâÊñπÊ≥ïÁöÑÁÆÄÂåñÂÆûÁé∞
    createStandardTemplates() {
        // ÂàõÂª∫Ê†áÂáÜÂ∑•‰ΩúÊµÅÊ®°Êùø
        const templates = [
            {
                name: 'Êñ∞ÂäüËÉΩÂºÄÂèëÊµÅÁ®ã',
                category: 'development',
                steps: [
                    { id: 'requirement-analysis', name: 'ÈúÄÊ±ÇÂàÜÊûê', type: 'task', executor: 'moxiaozhi' },
                    { id: 'ui-design', name: 'UIËÆæËÆ°', type: 'task', executor: 'moxiaomei' },
                    { id: 'development', name: 'ÂºÄÂèëÂÆûÁé∞', type: 'task', executor: 'moxiaoma' },
                    { id: 'testing', name: 'Ë¥®ÈáèÊµãËØï', type: 'task', executor: 'moxiaoce' },
                    { id: 'deployment', name: 'ÈÉ®ÁΩ≤‰∏äÁ∫ø', type: 'task', executor: 'moxiaoyun' }
                ]
            }
        ];
        templates.forEach(template => {
            this.createTemplate({
                id: `template-${template.name.toLowerCase().replace(/\s+/g, '-')}`,
                name: template.name,
                description: `Ê†áÂáÜ${template.name}`,
                category: template.category,
                version: '1.0',
                steps: template.steps.map(step => ({
                    ...step,
                    description: step.name,
                    estimatedDuration: 60,
                    priority: 'medium',
                    inputs: [],
                    outputs: [],
                    preconditions: [],
                    postconditions: [],
                    businessRules: [],
                    nextSteps: [],
                    errorHandling: { retryCount: 3 }
                })),
                qualityGates: [],
                approvalNodes: [],
                rolePermissions: new Map(),
                config: {
                    timeout: 3600,
                    retryCount: 3,
                    parallelExecution: false,
                    autoApproval: true
                }
            });
        });
    }
    async checkPreconditions(step, instance) { return true; }
    async checkPostconditions(step, instance) { return true; }
    prepareStepInputs(step, instance) { return {}; }
    async executeStepByType(step, instance, execution) {
        return { success: true, outputs: {} };
    }
    async performQualityCheck(step, instance) { return true; }
    async performApproval(step, instance) { return true; }
    async handleStepError(step, instance, execution) { }
    updateTemplateSuccessRate(templateId, success) { }
    calculateAverageDuration() { return 45; }
    getTopUsedTemplates() { return []; }
    calculatePerformanceMetrics() { return { avgSteps: 5, avgErrorRate: 2.5 }; }
    generateOptimizationSuggestions() { return ['‰ºòÂåñÊ≠•È™§ÊâßË°åÊó∂Èó¥', 'ÂáèÂ∞ëÈîôËØØÁéá']; }
}
exports.WorkflowEngine = WorkflowEngine;
exports.default = WorkflowEngine;
//# sourceMappingURL=WorkflowEngine.js.map