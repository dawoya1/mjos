/**
 * MJOS Main Entry Point
 * é­”å‰‘å·¥ä½œå®¤æ“ä½œç³»ç»Ÿä¸»å…¥å£
 */

// å¯¼å‡ºæ ¸å¿ƒç±»å‹
export * from './types/index';

// ç®€å•çš„MJOSç±»
export class MJOS {
  private version = '1.0.0';

  constructor() {
    console.log('MJOS initialized successfully!');
  }

  getVersion(): string {
    return this.version;
  }

  start(): void {
    console.log('MJOS started!');
  }

  stop(): void {
    console.log('MJOS stopped!');
  }
}

// é»˜è®¤å¯¼å‡º
export default MJOS;

/**
 * MJOSç³»ç»Ÿï¿½? * æ•´åˆæ‰€æœ‰ç»„ä»¶ï¼Œæä¾›ç»Ÿä¸€çš„ç³»ç»Ÿæ¥ï¿½? */
export class MJOS {
  private readonly logger: Logger;
  private readonly eventBus: EventBus;
  private readonly config: MJOSConfig;

  private mjosEngine?: MJOSEngine;
  private contextManager?: ContextManager;
  private collaborationEngine?: MultiAgentCollaborationEngine;
  private systemMonitor?: SystemMonitor;
  private enhancedMemorySystem?: EnhancedEngramMemorySystem;
  private dualModeReasoningEngine?: DualModeReasoningEngine;
  private errorRecoverySystem?: ErrorRecoverySystem;
  private performanceOptimizer?: PerformanceOptimizer;
  private securityManager?: SecurityManager;
  private mpmlEngine?: any;
  private mhpfRuntime?: any;
  private mpeoas?: any;
  private mmpt?: any;
  private mcpIntegration?: any;

  private isInitialized = false;
  private isRunning = false;

  constructor(config: Partial<MJOSConfig> = {}) {
    this.config = {
      logLevel: 'info',
      enableMPML: true,
      enableMHPF: true,
      enableMPEOAS: true,
      enableMMPT: true,
      enableMCP: true,
      ...config
    };

    // åˆ›å»ºæ—¥å¿—ï¿½?    this.logger = createLogger({
      level: this.config.logLevel,
      format: format.combine(
        format.timestamp(),
        format.errors({ stack: true }),
        format.json()
      ),
      transports: [
        new transports.Console({
          format: format.combine(
            format.colorize(),
            format.simple()
          )
        }),
        new transports.File({
          filename: 'logs/mjos.log',
          maxsize: 10485760, // 10MB
          maxFiles: 5
        })
      ]
    });

    // åˆ›å»ºäº‹ä»¶æ€»çº¿
    this.eventBus = new EventBus(this.logger);

    this.logger.info('MJOS System created', { config: this.config });
  }

  /**
   * åˆå§‹åŒ–ç³»ï¿½?   */
  public async initialize(): Promise<void> {
    if (this.isInitialized) {
      this.logger.debug('MJOS System already initialized');
      return;
    }

    try {
      this.logger.info('Initializing MJOS System');

      // åˆå§‹åŒ–æ ¸å¿ƒå¼•ï¿½?      this.mjosEngine = new MJOSEngine(this.logger, this.eventBus);
      await this.mjosEngine.initialize();

      // åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç®¡ç†ï¿½?      this.contextManager = new ContextManager(this.logger, this.eventBus);

      // å¼€å§‹åˆå§‹åŒ–å·¥ä½œé˜¶æ®µ
      await this.contextManager.startWorkPhase(
        'initialization',
        'MJOS System Initialization',
        []
      );

      // åˆå§‹åŒ–åä½œå¼•ï¿½?      this.collaborationEngine = new MultiAgentCollaborationEngine(
        this.logger,
        this.eventBus,
        this.contextManager,
        this.mpmlEngine?.getMemorySystem(),
        this.mpmlEngine?.getReasoningSystem()
      );

      // åˆå§‹åŒ–ç³»ç»Ÿç›‘ï¿½?      this.systemMonitor = new SystemMonitor(this.logger, this.eventBus);
      this.systemMonitor.startMonitoring();

      // åˆå§‹åŒ–å¢å¼ºè®°å¿†ç³»ï¿½?      this.enhancedMemorySystem = new EnhancedEngramMemorySystem(this.logger, this.eventBus);

      // åˆå§‹åŒ–åŒæ¨¡å¼æ¨ç†å¼•æ“
      this.dualModeReasoningEngine = new DualModeReasoningEngine(this.logger, this.eventBus);

      // åˆå§‹åŒ–é”™è¯¯æ¢å¤ç³»ï¿½?      this.errorRecoverySystem = new ErrorRecoverySystem(this.logger, this.eventBus);

      // åˆå§‹åŒ–æ€§èƒ½ä¼˜åŒ–ï¿½?      this.performanceOptimizer = new PerformanceOptimizer(this.logger, this.eventBus);

      // åˆå§‹åŒ–å®‰å…¨ç®¡ç†å™¨
      this.securityManager = new SecurityManager(this.logger, this.eventBus);

      // åˆå§‹åŒ–MPMLå¼•æ“
      if (this.config.enableMPML) {
        this.mpmlEngine = createMPMLEngine(this.logger, this.eventBus, {
          persistenceConfig: this.config.persistenceConfig
        });
        await this.mpmlEngine.initialize();
      }

      // åˆå§‹åŒ–MHPFè¿è¡Œï¿½?      if (this.config.enableMHPF) {
        this.mhpfRuntime = createMHPFRuntime(this.logger, this.eventBus);
        await this.mhpfRuntime.initialize(this.config.teamConfig);
      }

      // åˆå§‹åŒ–MPEOASå¼•æ“
      if (this.config.enableMPEOAS) {
        this.mpeoas = createMPEOASEngine(this.logger, this.eventBus);
        await this.mpeoas.initialize(this.config.teamConfig);
      }

      // åˆå§‹åŒ–MMPTå·¥å…·ï¿½?      if (this.config.enableMMPT) {
        this.mmpt = createMMPTToolkit(this.logger, this.eventBus);
        await this.mmpt.initialize(this.config.teamConfig);
      }

      // åˆå§‹åŒ–MCPé›†æˆ
      if (this.config.enableMCP) {
        this.mcpIntegration = createMCPIntegration(this.logger, this.eventBus, this.config.mcpOptions);
        await this.mcpIntegration.initialize();
      }

      this.isInitialized = true;

      this.logger.info('MJOS System initialized successfully');

      // å‘å¸ƒç³»ç»Ÿåˆå§‹åŒ–å®Œæˆäº‹ï¿½?      this.eventBus.publishEvent('mjos.system_initialized', {
        config: this.config,
        components: this.getEnabledComponents()
      }, 'MJOS');

    } catch (error) {
      this.logger.error('MJOS System initialization failed', {
        error: error instanceof Error ? error.message : String(error)
      });
      throw error;
    }
  }

  /**
   * å¯åŠ¨ç³»ç»Ÿ
   */
  public async start(context?: StateContext): Promise<void> {
    if (!this.isInitialized) {
      throw new Error('MJOS System must be initialized before starting');
    }

    if (this.isRunning) {
      this.logger.debug('MJOS System already running');
      return;
    }

    try {
      this.logger.info('Starting MJOS System');

      const systemContext: StateContext = context || {
        sessionId: `mjos-${Date.now()}`,
        teamId: 'magic-sword-studio',
        currentState: 'starting',
        timestamp: new Date(),
        metadata: { autoStart: true }
      };

      // å¯åŠ¨æ ¸å¿ƒå¼•æ“
      if (this.mjosEngine) {
        await this.mjosEngine.start(systemContext);
      }

      // å¯åŠ¨MPEOASå¼•æ“
      if (this.mpeoas) {
        await this.mpeoas.start(systemContext);
      }

      // æ¿€æ´»é»˜è®¤å›¢é˜Ÿé…ï¿½?      if (this.config.teamConfig && this.mhpfRuntime) {
        await this.mhpfRuntime.activateTeam(this.config.teamConfig, systemContext);
      }

      this.isRunning = true;

      this.logger.info('MJOS System started successfully');

      // å‘å¸ƒç³»ç»Ÿå¯åŠ¨å®Œæˆäº‹ä»¶
      this.eventBus.publishEvent('mjos.system_started', {
        context: systemContext,
        components: this.getEnabledComponents()
      }, 'MJOS');

    } catch (error) {
      this.logger.error('MJOS System start failed', {
        error: error instanceof Error ? error.message : String(error)
      });
      throw error;
    }
  }

  /**
   * åœæ­¢ç³»ç»Ÿ
   */
  public async stop(): Promise<void> {
    if (!this.isRunning) {
      this.logger.debug('MJOS System not running');
      return;
    }

    try {
      this.logger.info('Stopping MJOS System');

      // åœæ­¢MPEOASå¼•æ“
      if (this.mpeoas) {
        await this.mpeoas.stop();
      }

      // åœæ­¢æ ¸å¿ƒå¼•æ“
      if (this.mjosEngine) {
        await this.mjosEngine.stop();
      }

      this.isRunning = false;

      this.logger.info('MJOS System stopped successfully');

      // å‘å¸ƒç³»ç»Ÿåœæ­¢å®Œæˆäº‹ä»¶
      this.eventBus.publishEvent('mjos.system_stopped', {
        timestamp: new Date()
      }, 'MJOS');

    } catch (error) {
      this.logger.error('MJOS System stop failed', {
        error: error instanceof Error ? error.message : String(error)
      });
      throw error;
    }
  }

  /**
   * è·å–ç³»ç»ŸçŠ¶ï¿½?   */
  public getSystemStatus(): {
    initialized: boolean;
    running: boolean;
    components: string[];
    mjosEngine?: any;
    mpmlEngine?: any;
    mhpfRuntime?: any;
    mpeoas?: any;
    mmpt?: any;
    mcpIntegration?: any;
  } {
    const status = {
      initialized: this.isInitialized,
      running: this.isRunning,
      components: this.getEnabledComponents()
    };

    if (this.mjosEngine) {
      (status as any).mjosEngine = this.mjosEngine.getStatus();
    }

    if (this.mpmlEngine) {
      (status as any).mpmlEngine = this.mpmlEngine.getStatus();
    }

    if (this.mhpfRuntime) {
      (status as any).mhpfRuntime = this.mhpfRuntime.getStatus();
    }

    if (this.mpeoas) {
      (status as any).mpeoas = this.mpeoas.getStatus();
    }

    if (this.mmpt) {
      (status as any).mmpt = this.mmpt.getStatus();
    }

    if (this.mcpIntegration) {
      (status as any).mcpIntegration = this.mcpIntegration.getStatus();
    }

    return status;
  }

  /**
   * è·å–å·²å¯ç”¨çš„ç»„ä»¶
   */
  private getEnabledComponents(): string[] {
    const components: string[] = [];

    if (this.mjosEngine) components.push('MJOSEngine');
    if (this.contextManager) components.push('ContextManager');
    if (this.collaborationEngine) components.push('CollaborationEngine');
    if (this.systemMonitor) components.push('SystemMonitor');
    if (this.enhancedMemorySystem) components.push('EnhancedMemorySystem');
    if (this.dualModeReasoningEngine) components.push('DualModeReasoningEngine');
    if (this.errorRecoverySystem) components.push('ErrorRecoverySystem');
    if (this.performanceOptimizer) components.push('PerformanceOptimizer');
    if (this.securityManager) components.push('SecurityManager');
    if (this.mpmlEngine) components.push('MPMLEngine');
    if (this.mhpfRuntime) components.push('MHPFRuntime');
    if (this.mpeoas) components.push('MPEOASEngine');
    if (this.mmpt) components.push('MMPTToolkit');
    if (this.mcpIntegration) components.push('MCPIntegration');

    return components;
  }

  /**
   * è·å–ä¸Šä¸‹æ–‡ç®¡ç†å™¨
   */
  public getContextManager(): ContextManager | undefined {
    return this.contextManager;
  }

  /**
   * å¼€å§‹æ–°çš„å·¥ä½œé˜¶ï¿½?   */
  public async startWorkPhase(
    phase: 'analysis' | 'design' | 'implementation' | 'testing' | 'optimization' | 'deployment',
    taskDescription: string
  ): Promise<string | null> {
    if (!this.contextManager) {
      throw new Error('Context Manager not enabled');
    }

    return await this.contextManager.startWorkPhase(phase, taskDescription);
  }

  /**
   * æ›´æ–°å½“å‰ä¸Šä¸‹ï¿½?   */
  public async updateContext(updates: any): Promise<void> {
    if (!this.contextManager) {
      throw new Error('Context Manager not enabled');
    }

    return await this.contextManager.updateContext(updates);
  }

  /**
   * å®Œæˆå·¥ä½œé˜¶æ®µ
   */
  public async completeWorkPhase(
    achievements: any[],
    nextPhase?: 'analysis' | 'design' | 'implementation' | 'testing' | 'optimization' | 'deployment'
  ): Promise<void> {
    if (!this.contextManager) {
      throw new Error('Context Manager not enabled');
    }

    return await this.contextManager.completeWorkPhase(achievements, nextPhase);
  }

  /**
   * è·å–åä½œå¼•æ“
   */
  public getCollaborationEngine(): MultiAgentCollaborationEngine | undefined {
    return this.collaborationEngine;
  }

  /**
   * å¯åŠ¨åä½œé¡¹ç›®
   */
  public async startCollaborationProject(
    projectName: string,
    description: string,
    objectives: string[],
    timeline: { startDate: Date; endDate: Date }
  ): Promise<string | null> {
    if (!this.collaborationEngine) {
      throw new Error('Collaboration Engine not enabled');
    }

    return await this.collaborationEngine.startCollaborationProject(
      projectName,
      description,
      objectives,
      timeline
    );
  }

  /**
   * è·å–åä½œç»Ÿè®¡
   */
  public getCollaborationStatistics(): any {
    if (!this.collaborationEngine) {
      throw new Error('Collaboration Engine not enabled');
    }

    return this.collaborationEngine.getCollaborationStatistics();
  }

  /**
   * è·å–ç³»ç»Ÿç›‘æ§ï¿½?   */
  public getSystemMonitor(): SystemMonitor | undefined {
    return this.systemMonitor;
  }

  /**
   * è·å–ç³»ç»ŸçŠ¶ï¿½?   */
  public getSystemStatus(): any {
    if (!this.systemMonitor) {
      throw new Error('System Monitor not enabled');
    }

    return this.systemMonitor.getSystemStatus();
  }

  /**
   * è·å–ç³»ç»ŸæŒ‡æ ‡
   */
  public getSystemMetrics(limit?: number): any[] {
    if (!this.systemMonitor) {
      throw new Error('System Monitor not enabled');
    }

    return this.systemMonitor.getMetricsHistory(limit);
  }

  /**
   * è·å–å¥åº·æ£€æŸ¥ç»“ï¿½?   */
  public getHealthChecks(): any[] {
    if (!this.systemMonitor) {
      throw new Error('System Monitor not enabled');
    }

    return this.systemMonitor.getHealthChecks();
  }

  /**
   * è·å–æ´»è·ƒå‘Šè­¦
   */
  public getActiveAlerts(): any[] {
    if (!this.systemMonitor) {
      throw new Error('System Monitor not enabled');
    }

    return this.systemMonitor.getActiveAlerts();
  }

  /**
   * è·å–å¢å¼ºè®°å¿†ç³»ç»Ÿ
   */
  public getEnhancedMemorySystem(): EnhancedEngramMemorySystem | undefined {
    return this.enhancedMemorySystem;
  }

  /**
   * å­˜å‚¨å¢å¼ºè®°å¿†
   */
  public async storeEnhancedMemory(
    content: any,
    metadata: any,
    neuralPattern?: any
  ): Promise<string | null> {
    if (!this.enhancedMemorySystem) {
      throw new Error('Enhanced Memory System not enabled');
    }

    return await this.enhancedMemorySystem.storeEnhancedEngram(content, metadata, neuralPattern);
  }

  /**
   * è·å–è®°å¿†ç»Ÿè®¡
   */
  public getEnhancedMemoryStatistics(): any {
    if (!this.enhancedMemorySystem) {
      throw new Error('Enhanced Memory System not enabled');
    }

    return this.enhancedMemorySystem.getMemoryStatistics();
  }

  /**
   * è·å–åŒæ¨¡å¼æ¨ç†å¼•ï¿½?   */
  public getDualModeReasoningEngine(): DualModeReasoningEngine | undefined {
    return this.dualModeReasoningEngine;
  }

  /**
   * æ™ºèƒ½æ¨ç†
   */
  public async performIntelligentReasoning(
    problem: string,
    context: any,
    sessionId?: string
  ): Promise<any> {
    if (!this.dualModeReasoningEngine) {
      throw new Error('Dual Mode Reasoning Engine not enabled');
    }

    return await this.dualModeReasoningEngine.intelligentReasoning(problem, context, sessionId);
  }

  /**
   * è·å–æ¨ç†ç»Ÿè®¡
   */
  public getReasoningStatistics(): any {
    if (!this.dualModeReasoningEngine) {
      throw new Error('Dual Mode Reasoning Engine not enabled');
    }

    return this.dualModeReasoningEngine.getReasoningStatistics();
  }

  /**
   * è·å–é”™è¯¯æ¢å¤ç³»ç»Ÿ
   */
  public getErrorRecoverySystem(): ErrorRecoverySystem | undefined {
    return this.errorRecoverySystem;
  }

  /**
   * å¤„ç†é”™è¯¯
   */
  public async handleError(component: string, error: Error, context: Record<string, any> = {}): Promise<boolean> {
    if (!this.errorRecoverySystem) {
      throw new Error('Error Recovery System not enabled');
    }

    return await this.errorRecoverySystem.handleError(component, error, context);
  }

  /**
   * è·å–ç³»ç»Ÿå¥åº·çŠ¶ï¿½?   */
  public getSystemHealthStatus(): any {
    if (!this.errorRecoverySystem) {
      throw new Error('Error Recovery System not enabled');
    }

    return this.errorRecoverySystem.getSystemHealth();
  }

  /**
   * è·å–æ€§èƒ½ä¼˜åŒ–ï¿½?   */
  public getPerformanceOptimizer(): PerformanceOptimizer | undefined {
    return this.performanceOptimizer;
  }

  /**
   * è·å–æ€§èƒ½æŠ¥å‘Š
   */
  public getPerformanceReport(): any {
    if (!this.performanceOptimizer) {
      throw new Error('Performance Optimizer not enabled');
    }

    return this.performanceOptimizer.getPerformanceReport();
  }

  /**
   * è·å–å®‰å…¨ç®¡ç†ï¿½?   */
  public getSecurityManager(): SecurityManager | undefined {
    return this.securityManager;
  }

  /**
   * ç”¨æˆ·è®¤è¯
   */
  public async authenticateUser(
    username: string,
    password: string,
    ipAddress: string,
    userAgent: string
  ): Promise<any> {
    if (!this.securityManager) {
      throw new Error('Security Manager not enabled');
    }

    return await this.securityManager.authenticateUser(username, password, ipAddress, userAgent);
  }

  /**
   * è·å–å®‰å…¨æŠ¥å‘Š
   */
  public getSecurityReport(): any {
    if (!this.securityManager) {
      throw new Error('Security Manager not enabled');
    }

    return this.securityManager.getSecurityReport();
  }

  /**
   * æ¸…ç†èµ„æº
   */
  public async destroy(): Promise<void> {
    try {
      this.logger.info('Destroying MJOS System');

      if (this.isRunning) {
        await this.stop();
      }

      // æ¸…ç†å„ä¸ªç»„ä»¶
      if (this.mcpIntegration) {
        this.mcpIntegration.destroy();
      }

      if (this.mmpt) {
        this.mmpt.destroy();
      }

      if (this.mpmlEngine) {
        await this.mpmlEngine.destroy();
      }

      if (this.securityManager) {
        this.securityManager.destroy();
      }

      if (this.performanceOptimizer) {
        await this.performanceOptimizer.destroy();
      }

      if (this.errorRecoverySystem) {
        this.errorRecoverySystem.destroy();
      }

      if (this.dualModeReasoningEngine) {
        this.dualModeReasoningEngine.destroy();
      }

      if (this.enhancedMemorySystem) {
        this.enhancedMemorySystem.destroy();
      }

      if (this.systemMonitor) {
        this.systemMonitor.destroy();
      }

      if (this.collaborationEngine) {
        this.collaborationEngine.destroy();
      }

      if (this.contextManager) {
        this.contextManager.destroy();
      }

      if (this.mjosEngine) {
        await this.mjosEngine.destroy();
      }

      this.logger.info('MJOS System destroyed successfully');

    } catch (error) {
      this.logger.error('MJOS System destruction failed', {
        error: error instanceof Error ? error.message : String(error)
      });
      throw error;
    }
  }
}

/**
 * åˆ›å»ºMJOSå®ä¾‹çš„ä¾¿æ·å‡½ï¿½? */
export function createMJOS(config?: Partial<MJOSConfig>): MJOS {
  return new MJOS(config);
}

// å¯¼å‡ºåä½œæ¨¡å—
export * from './collaboration/index';

// å¯¼å‡ºç›‘æ§æ¨¡å—
export * from './monitoring/index';

// å¯¼å‡ºé«˜çº§è®°å¿†æ¨¡å—
export * from './advanced-memory/index';

// å¯¼å‡ºé«˜çº§æ¨ç†æ¨¡å—
export * from './advanced-reasoning/index';

// å¯¼å‡ºå®¹é”™æ¨¡å—
export * from './fault-tolerance/index';

// å¯¼å‡ºæ€§èƒ½æ¨¡å—
export * from './performance/index';

// å¯¼å‡ºå®‰å…¨æ¨¡å—
export * from './security/index';

/**
 * é»˜è®¤å¯¼å‡º
 */
export default MJOS;

// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶ï¼Œå¯åŠ¨MJOSæ¼”ç¤º
if (require.main === module) {
  async function demo() {
    console.log('ğŸ—¡ï¿½? Starting MJOS Demo...\n');

    try {
      // åˆ›å»ºMJOSå®ä¾‹
      const mjos = createMJOS({
        logLevel: 'debug',
        enableMPML: true,
        enableMHPF: true,
        enableMPEOAS: true,
        enableMMPT: true,
        enableMCP: true
      });

      // åˆå§‹ï¿½?      console.log('ğŸ“¦ Initializing MJOS...');
      await mjos.initialize();
      console.log('ï¿½?MJOS initialized successfully');

      // å¯åŠ¨
      console.log('\nğŸš€ Starting MJOS...');
      await mjos.start();
      console.log('ï¿½?MJOS started successfully');

      // æ˜¾ç¤ºçŠ¶ï¿½?      console.log('\nğŸ“Š MJOS Status:');
      const status = mjos.getSystemStatus();
      console.log(JSON.stringify(status, null, 2));

      // ç­‰å¾…ä¸€æ®µæ—¶é—´ååœæ­¢
      console.log('\nï¿½?Running for 5 seconds...');
      await new Promise(resolve => setTimeout(resolve, 5000));

      // åœæ­¢
      console.log('\nğŸ›‘ Stopping MJOS...');
      await mjos.stop();
      console.log('ï¿½?MJOS stopped successfully');

      console.log('\nğŸ‰ MJOS Demo completed!');

    } catch (error) {
      console.error('ğŸ’¥ Demo failed:', error);
      process.exit(1);
    }
  }

  demo().catch(console.error);
}
